<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Because its fun to map stuff…</title>
    <link rel="stylesheet" href="../../../theme/css/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="http://www.carsonfarmer.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Carson Farmer Atom Feed" />
    <link href="http://www.carsonfarmer.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Carson Farmer RSS Feed" />
    <script type="text/javascript" src="//code.jquery.com/jquery-2.0.2.js"></script>
    <script src="../../../libs/bootstrap-3.1.1/dist/js/bootstrap.min.js"></script>
</head> 

<body id="index" class="home">
<img id="bg" src="../../../theme/images/bg/bg-1024.png" style="position: fixed; top: 0; left: 0;">
        <!-- <header id="banner" class="body"> -->
<nav class="navbar navbar-default navbar-fixed-top sticky shadow" role="navigation">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
<a class="brand" id="home" href="../../../">
                <img src="../../../theme/images/title.svg" id="title" class="svg"></img>
            </a>
	
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li>
              <a href="../../../about/">
                  <i class="fa fa-info-circle"></i> About
              </a>
            </li>
            <li>
              <a href="../../../curriculum-vitae/">
                  <i class="fa fa-rocket"></i> Curriculum&nbsp;Vitae
              </a>
            </li>
            <li>
              <a href="../../../research/">
                  <i class="fa fa-globe"></i> Research
              </a>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                  <i class="fa fa-group"></i> Social <b class="caret"></b>
              </a>
              <ul class="dropdown-menu" role="menu">
                <li>
                  <a href="http://www.carsonfarmer.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">
                  <i class="fa fa-rss"></i> atom feed</a>
                </li>
                <li>
                  <a href="http://www.carsonfarmer.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">
                  <i class="fa fa-rss"></i> rss feed</a>
                </li>
                <li class="divider"></li>
                <li>
                  <a href="https://twitter.com/CarsonFarmer"><i class="fa fa-twitter"></i> twitter</a>
                </li>
                <li>
                  <a href="https://github.com/cfarmer"><i class="fa fa-github"></i> github</a>
                </li>
                <li>
                  <a href="http://about.me/carson.farmer"><i class="fa fa-user"></i> about.me</a>
                </li>
                <li>
                  <a href="http://hunter-cuny.academia.edu/CarsonFarmer"><i class="fa fa-book"></i> academia.edu</a>
                </li>
                <li>
                  <a href="http://www.linkedin.com/pub/carson-farmer/40/3bb/27/"><i class="fa fa-linkedin"></i> linkedin</a>
                </li>
                <li>
                  <a href="https://plus.google.com/108062014159451325697/about/p/pub"><i class="fa fa-google-plus"></i> google+</a>
                </li>
                <li>
                  <a href="http://cuny.is/cfarmer"><i class="fa fa-comment-o"></i> cuny.is</a>
                </li>
                <li>
                  <a href="mailto:carson.farmer@gmail.com"><i class="fa fa-envelope"></i> email</a>
                </li>
              </ul>
            </li>
          </ul>
          <form class="navbar-search pull-right">
            <div class="input-append">
              <input type="search" class="form-control" id="top-query" placeholder="  ">
            <div class="dropdown pull-right" id="top-dropdown">
              <a class="dropdown-toggle" id="top-toggle" role="button" data-toggle="dropdown" data-target="#" href="."></a>
              <ul class="dropdown-menu pull-right" role="menu" id="top-results" aria-labelledby="top-toggle"></ul></div>
            </div>
          </form>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>

        <!-- </header> -->
<section id="content" class="body">
  <article class="hentry shadow">
    <header>
      <h1 class="entry-title">
        <a href="../../../2012/03/because-its-fun-to-map-stuff/" rel="bookmark"
           title="Permalink to Because its fun to map stuff…">Because its fun to map&nbsp;stuff&#8230;</a></h1>
      <abbr class="published" title="2012-03-30T17:46:00">
          <i class="fa fa-calendar"></i>
          Fri 30 March 2012
      </abbr>
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="CarsonFarmer">Tweet</a>
<script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
<div class="g-plusone" data-size="medium"></div>
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">
 lang: en_US
</script>
<script type="IN/Share" data-counter="right"></script>    </header>

    <div class="entry-content">
      <p>Its been quite a while since my last post, and its Friday and I was
feeling creative, so I decided to map something! I&#8217;ve been looking for
an excuse to produce a nice graphic like the one <a href="http://underdark.wordpress.com/about/">Anita Graser</a>
created to represent Vienna’s green-spaces. She used <a href="http://qgis.org/">Quantum
<span class="caps">GIS</span></a> to produce a <a href="http://underdark.wordpress.com/2012/03/04/mapping-density-with-hexagonal-grids/">hexagonal grid</a> for representing the density of
Viennese trees instead of the standard heat map or kernel density map,
and the results are quite nice! I&#8217;m a huge fan of <span class="caps">QGIS</span>, but I tend to do
most of my work in R, so I decided to see if I could produce something
similar using R. Turns out you can, and the final results are displayed
below (read on to see the full work-flow). Instead of trees, I went
ahead and mapped the locations of unique visitors to
<code>http://www.carsonfarmer.com/</code> between 2009 and&nbsp;2011:</p>
<p><a href="../../../images/website_visitors.svg"><img alt="Visitors map" src="../../../images/website_visitors.svg" /></a></p>
<h3>Work-flow</h3>
<p>Firstly, I downloaded the logs for <code>www.carsonfarmer.com</code>. I did this
directly from the console, though I&#8217;m pretty sure I could have done this
from R as well. Next, I needed to extract the unique <span class="caps">IP</span> addresses from
the logs. I found this nice grep one-liner from <a href="http://blogs.law.harvard.edu/djcp/2009/04/how-to-extract-uniq-ips-from-apache-via-grep-cut-and-uniq/">here</a>, which I
modified to grab all unique <span class="caps">IP</span> addresses that &#8216;<span class="caps">GET</span>&#8217; something from the&nbsp;site:</p>
<div class="highlight"><pre>grep <span class="s1">&#39;<span class="caps">GET</span>&#39;</span> access.log | cut -d<span class="s1">&#39; &#39;</span> -f1 | sort | uniq &gt; ip_addresses.log
</pre></div>


<p>To actually map the <span class="caps">IP</span> addresses, I obviously needed some way to convert
the raw <span class="caps">IP</span> addresses to latitude and longitude coordinates. Enter the
very nice <a href="http://www.datasciencetoolkit.org/">Data Science Toolkit (<span class="caps">DSTK</span>)</a> from Pete Warden and the very
handy <a href="https://github.com/rtelmore/RDSTK"><span class="caps">RDSTK</span> R package</a> from Ryan Elmore! Basically, the <span class="caps">DSTK</span> has an
<span class="caps">API</span> that can be queried for all sorts of information useful for &#8216;data
science&#8217; applications, and the <span class="caps">RDSTK</span> makes it possible to query to <span class="caps">API</span>
directly from within R. I first heard about both these projects from the
<a href="http://blog.revolutionanalytics.com">Revolution Analytics blog</a>, where there is an <a href="http://blog.revolutionanalytics.com/2011/05/mapping-locations-in-r-with-the-data-science-toolkit.html">article</a> summarising
Ryan Elmore&#8217;s <a href="http://thelogcabin.wordpress.com/2011/05/02/r-and-the-data-science-toolkit/">work on <span class="caps">RDSTK</span></a>, and a few other handy links. <span class="caps">RDSTK</span>
isn&#8217;t (yet?) available on <a href="http://cran.r-project.org/"><span class="caps">CRAN</span></a>, so I downloaded it directly from&nbsp;github:</p>
<div class="highlight"><pre>wget https://github.com/rtelmore/RDSTK/raw/master/src/RDSTK_1.0.tar.gz
</pre></div>


<p>Then I installed it via <code>R CMD INSTALL</code> (note that it requires other R
packages: <code>RCurl</code>, <code>rjson</code>, and <code>plyr</code>):</p>
<div class="highlight"><pre>R CMD INSTALL RDSTK_1.0.tar.gz
</pre></div>


<p>Once I had all that stuff installed and ready to go, I actually started
up an R session and got&nbsp;working:</p>
<div class="highlight"><pre>addresses <span class="o">=</span> read.table<span class="p">(</span><span class="s">&#39;ip_addresses.log&#39;</span><span class="p">,</span> col.names<span class="o">=</span><span class="s">&#39;address&#39;</span><span class="p">)</span>
library<span class="p">(</span><span class="caps">RDSTK</span><span class="p">)</span>
<span class="o">?</span> ip2coordinates
</pre></div>


<p>The <code>ip2coordinates</code> function requires multiple IPs to be contained
within a single string with comma-separated <span class="caps">IP</span> addresses, but we can
only do a few IPs at a time (about 100 I think?) so I had to do this
part in a loop (it probably isn&#8217;t polite to slam <span class="caps">DSTK</span> with 1,000s of
requests, so be&nbsp;nice!).</p>
<div class="highlight"><pre>ips <span class="o">=</span> paste<span class="p">(</span>as.character<span class="p">(</span>addresses<span class="o">$</span>address<span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">80</span><span class="p">]),</span> collapse<span class="o">=</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
out <span class="o">=</span> ip2coordinates<span class="p">(</span>ips<span class="p">)</span>
last <span class="o">=</span> <span class="m">80</span>
s <span class="o">=</span> c<span class="p">(</span>seq<span class="p">(</span><span class="m">160</span><span class="p">,</span> nrow<span class="p">(</span>addresses<span class="p">),</span> <span class="m">80</span><span class="p">),</span> nrow<span class="p">(</span>addresses<span class="p">))</span>
<span class="kr">for</span> <span class="p">(</span>i <span class="kr">in</span> s<span class="p">)</span> <span class="p">{</span>
    ips <span class="o">=</span> paste<span class="p">(</span>as.character<span class="p">(</span>addresses<span class="o">$</span>address<span class="p">[(</span>last<span class="m">+1</span><span class="p">)</span><span class="o">:</span>i<span class="p">]),</span> collapse<span class="o">=</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
    out <span class="o">=</span> rbind<span class="p">(</span>out<span class="p">,</span> ip2coordinates<span class="p">(</span>ips<span class="p">))</span>
    last <span class="o">=</span> i
<span class="p">}</span>
</pre></div>


<p>Once that is done running, the next step(s) are to a) convert the
returned <code>data.frame</code> to a <code>SpatialPointsDataFrame</code>, b) create a
<code>SpatialGrid</code> based on the points, c) create a <code>SpatialPolygons</code> object
from a hexagonal sample of the grid, and then finally d) create a
<code>SpatialPolygonsDataFrame</code> for&nbsp;plotting:</p>
<div class="highlight"><pre>library<span class="p">(</span>sp<span class="p">)</span>
<span class="c1"># make the output into a Spatial* object</span>
coordinates<span class="p">(</span>out<span class="p">)</span> <span class="o">=</span> <span class="o">~</span>longitude<span class="o">+</span>latitude
library<span class="p">(</span>maptools<span class="p">)</span> <span class="c1"># need this for the following function</span>
sg <span class="o">=</span> Sobj_SpatialGrid<span class="p">(</span>out<span class="p">,</span> maxDim<span class="o">=</span><span class="m">200</span><span class="p">,</span> n<span class="o">=</span><span class="kc"><span class="caps">NULL</span></span><span class="p">)</span><span class="o">$</span><span class="caps">SG</span>
hex_pts <span class="o">=</span> spsample<span class="p">(</span>sg<span class="p">,</span> type<span class="o">=</span><span class="s">&#39;hexagonal&#39;</span><span class="p">,</span> cellsize<span class="o">=</span>sg<span class="o">@</span>grid<span class="o">@</span>cellsize<span class="p">)</span>
hex_poly <span class="o">=</span> HexPoints2SpatialPolygons<span class="p">(</span>hex_pts<span class="p">)</span>
pts_poly <span class="o">=</span> over<span class="p">(</span>hex_poly<span class="p">,</span> out<span class="p">,</span> returnList<span class="o">=</span><span class="kc"><span class="caps">TRUE</span></span><span class="p">)</span>
pts_poly_count <span class="o">=</span> sapply<span class="p">(</span>pts_poly<span class="p">,</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> nrow<span class="p">(</span>x<span class="p">))</span>
poly <span class="o">=</span> SpatialPolygonsDataFrame<span class="p">(</span>poly<span class="p">,</span> data.frame<span class="p">(</span><span class="s">&#39;count&#39;</span><span class="o">=</span>pts_poly_count<span class="p">),</span> 
    match.<span class="caps">ID</span><span class="o">=</span><span class="kc"><span class="caps">FALSE</span></span><span class="p">)</span>
</pre></div>


<p>Ok, now for some&nbsp;plotting!</p>
<div class="highlight"><pre><span class="c1"># pick some reasonable break points</span>
breaks <span class="o">=</span> c<span class="p">(</span><span class="m">1.0</span><span class="p">,</span> <span class="m">10.0</span><span class="p">,</span> <span class="m">20.0</span><span class="p">,</span> <span class="m">50.0</span><span class="p">,</span> <span class="m">100.0</span><span class="p">,</span> <span class="m">500.0</span><span class="p">,</span> <span class="m">2000.0</span><span class="p">)</span>
<span class="c1"># use RColorBrewer to get a nice blue palette</span>
library<span class="p">(</span>RColorBrewer<span class="p">)</span>
<span class="c1"># don&#39;t use the lightest colour, it looks washed out</span>
cols <span class="o">=</span> brewer.pal<span class="p">(</span><span class="m">7</span><span class="p">,</span><span class="s">&quot;Blues&quot;</span><span class="p">)[</span><span class="m">-1</span><span class="p">]</span> 
<span class="c1"># plot the grid, which produces something close to our final product</span>
spplot<span class="p">(</span>poly<span class="p">[</span>poly<span class="o">$</span>count<span class="o">&gt;</span><span class="m">0</span><span class="p">,],</span> col<span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> col.regions<span class="o">=</span>cols<span class="p">,</span> at<span class="o">=</span>breaks<span class="p">,</span> 
       par.settings<span class="o">=</span>list<span class="p">(</span>axis.line<span class="o">=</span>list<span class="p">(</span>col<span class="o">=</span><span class="s">&#39;transparent&#39;</span><span class="p">)))</span>
</pre></div>


<p>I then used <a href="http://inkscape.org/">Inkscape</a> to tweak the final product, adding titles and
labels and modifying the colour key to look like something a bit more
suited to the map at hand. In the end I had a nice map of my blog
readers, and an excellent way to procrastinate on a sunny Friday&nbsp;afternoon!</p>
    <p class="category">
        <i class="fa fa-certificate fa-fw fa-lg"></i>
        <a class="label label-primary" href="../../../category/helpful-tip.html">Helpful tip</a> 
    </p>
    <p class="tag">
        <i class="fa fa-tags fa-fw fa-lg"></i>
        <a class="label label-primary" href="../../../tag/data-science-toolkit.html">Data Science Toolkit</a>
        </span>
        <a class="label label-primary" href="../../../tag/hexagonal-grid.html">Hexagonal Grid</a>
        </span>
        <a class="label label-primary" href="../../../tag/ip-addreses.html">IP Addreses</a>
        </span>
        <a class="label label-primary" href="../../../tag/mapping.html">Mapping</a>
        </span>
        <a class="label label-primary" href="../../../tag/r-spatial.html">R spatial</a>
        </span>
        <a class="label label-primary" href="../../../tag/free-open-source-software-foss.html">Free open-source software (FOSS)</a>
        </span>
        <a class="label label-primary" href="../../../tag/how-to.html">How to</a>
        </span>
    </p>
    </div><!-- /.entry-content -->
      <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          var disqus_identifier = "2012/03/because-its-fun-to-map-stuff/";
          var disqus_url = "../../../2012/03/because-its-fun-to-map-stuff/";
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://carsonfarmer.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </div>

  </article>
</section>
        <section id="extras" class="body shadow">
<div class="twitter">
    <h2><i class="fa fa-twitter"></i> twitter</h2>
    <a class="twitter-timeline" href="https://twitter.com/CarsonFarmer" 
        data-chrome="nofooter noheader noborders transparent" 
        data-widget-id="330339195518337025"
        height="300" lang="EN"
        data-related="CarsonFarmer">
        Tweets by @CarsonFarmer
    </a>
    <script>
        !function(d,s,id){
            var js,fjs=d.getElementsByTagName(s)[0], p=/^http:/.test(d.location)?'http':'https';
            if(!d.getElementById(id)){
                js=d.createElement(s);
                js.id=id;js.src=p+"://platform.twitter.com/widgets.js";
                fjs.parentNode.insertBefore(js,fjs);
            }
        }(document,"script","twitter-wjs");
    </script>
</div>
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body ">
            <address id="about" class="vcard body shadow">
                <ul id="links">
                    <li><a href="../../../categories.html"><i class="fa fa-certificate fa-fw"></i> Categories</a></li>
                    <li><a href="../../../tags.html"><i class="fa fa-tags fa-fw"></i> Tags</a></li>
                </ul>
                Carson Farmer | Assistant Professor of GIScience | Department Geography</br>
                Hunter College, CUNY | 695 Park Avenue, New York, NY, 10065</br>
            <p class="social-icons attribution">
                  <a href="https://twitter.com/CarsonFarmer" data-toggle="tooltip" title="" data-original-title="twitter" data-placement="bottom">
                    <i class="fa fa-twitter fa-lg"></i>
                  </a>
                  <script >
                  $("[data-toggle=tooltip]").tooltip();
                  </script>
                  <a href="https://github.com/cfarmer" data-toggle="tooltip" title="" data-original-title="github" data-placement="bottom">
                    <i class="fa fa-github fa-lg"></i>
                  </a>
                  <script >
                  $("[data-toggle=tooltip]").tooltip();
                  </script>
                  <a href="http://about.me/carson.farmer" data-toggle="tooltip" title="" data-original-title="about.me" data-placement="bottom">
                    <i class="fa fa-user fa-lg"></i>
                  </a>
                  <script >
                  $("[data-toggle=tooltip]").tooltip();
                  </script>
                  <a href="http://hunter-cuny.academia.edu/CarsonFarmer" data-toggle="tooltip" title="" data-original-title="academia.edu" data-placement="bottom">
                    <i class="fa fa-book fa-lg"></i>
                  </a>
                  <script >
                  $("[data-toggle=tooltip]").tooltip();
                  </script>
                  <a href="http://www.linkedin.com/pub/carson-farmer/40/3bb/27/" data-toggle="tooltip" title="" data-original-title="linkedin" data-placement="bottom">
                    <i class="fa fa-linkedin fa-lg"></i>
                  </a>
                  <script >
                  $("[data-toggle=tooltip]").tooltip();
                  </script>
                  <a href="https://plus.google.com/108062014159451325697/about/p/pub" data-toggle="tooltip" title="" data-original-title="google+" data-placement="bottom">
                    <i class="fa fa-google-plus fa-lg"></i>
                  </a>
                  <script >
                  $("[data-toggle=tooltip]").tooltip();
                  </script>
                  <a href="http://cuny.is/cfarmer" data-toggle="tooltip" title="" data-original-title="cuny.is" data-placement="bottom">
                    <i class="fa fa-comment-o fa-lg"></i>
                  </a>
                  <script >
                  $("[data-toggle=tooltip]").tooltip();
                  </script>
                  <a href="mailto:carson.farmer@gmail.com" data-toggle="tooltip" title="" data-original-title="email" data-placement="bottom">
                    <i class="fa fa-envelope fa-lg"></i>
                  </a>
                  <script >
                  $("[data-toggle=tooltip]").tooltip();
                  </script>
            </p>
            </address><!-- /#about -->
            <p class="attribution">This blog is proudly 
                powered by <a href="http://getpelican.com/">Pelican</a>, 
                which takes great advantage of 
                <a href="http://python.org">Python</a>.</br>
                Icons are courtesy of 
                <a href="http://fortawesome.github.io/Font-Awesome/">FontAwesome</a> 
                and the styling is mostly done via 
                <a href="http://getbootstrap.com/">Bootstrap</a>.</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41110370-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'carsonfarmer';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script src="../../../theme/js/tools.js"></script>
</body>
</html>