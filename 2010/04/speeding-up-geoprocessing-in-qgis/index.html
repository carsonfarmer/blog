<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Speeding up geoprocessing in QGIS</title>
    <link rel="stylesheet" href="http://www.carsonfarmer.com/theme/css/main.css">
    <!-- <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet"> -->
    <link href="http://www.carsonfarmer.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Carson Farmer Atom Feed" />
    <link href="http://www.carsonfarmer.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Carson Farmer RSS Feed" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
    <script src="http://www.carsonfarmer.com/libs/bootstrap/js/bootstrap.min.js"></script>
    
    <!-- <script type="text/javascript" src="http://leaflet.cloudmade.com/dist/leaflet.js"></script> -->
    <!-- <link rel="stylesheet" href="http://leaflet.cloudmade.com/dist/leaflet.css" /> -->
    <!--[if lte IE 8]><link rel="stylesheet" href="http://leaflet.cloudmade.com/dist/leaflet.ie.css" /><![endif]-->
    <!-- <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.3"></script> -->
    <!--<script src="http://twitter.github.io/bootstrap/assets/js/bootstrap-tooltip.js"></script> -->
    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head> 

<body id="index" class="home">
<img id="bg" src="http://www.carsonfarmer.com/theme/images/bg/bg-1024.png">
        <header id="banner" class="body">
                <!-- <h1><a href="http://www.carsonfarmer.com/">Carson Farmer  <strong>www.carsonfarmer.com</strong></a></h1> -->
                <div class="navbar navbar-fixed-top sticky" role='navigation'>
                    <div class="navbar-inner">
                        <ul class="nav">
                            <form class="navbar-search pull-right">
                            <div class='input-append'>
                            <input type="text" class="search-query" id="top-query" placeholder="Search...">
                            <div class="dropdown pull-right" id="top-dropdown">
                            <a class="dropdown-toggle" id="top-toggle" role="button" data-toggle="dropdown" data-target="#" href="."></a>
                            <ul class="dropdown-menu pull-right" role="menu" id="top-results" aria-labelledby="top-toggle"></ul></div>
                            </div>
                            </form>
<li><a class="brand" id="home" href="http://www.carsonfarmer.com/">
                                    <img src="http://www.carsonfarmer.com/theme/images/title.svg" id="title" class="svg"></img>
                                </a></li>
                                    <li><a href="http://www.carsonfarmer.com/about/"><i class="fa fa-info-circle"></i> About</a></li>
                                    <li><a href="http://www.carsonfarmer.com/curriculum-vitae/"><i class="fa fa-rocket"></i> Curriculum&nbsp;Vitae</a></li>
                                    <li><a href="http://www.carsonfarmer.com/research/"><i class="fa fa-globe"></i> Research</a></li>
                            <li class="dropdown">
                                <a class="dropdown-toggle" data-toggle="dropdown" role="button" id="social-drop" href="#">
                                <i class="fa fa-group"></i> Social<span class="caret"></span></a>
                                <ul class="dropdown-menu pull-right" role="menu" id="social-menu" aria-labelledby="social-drop">
                                    <li>
                                      <a href="http://www.carsonfarmer.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">
                                      <i class="fa fa-rss"></i> atom feed</a>
                                    </li>
                                    <li>
                                      <a href="http://www.carsonfarmer.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">
                                      <i class="fa fa-rss"></i> rss feed</a>
                                    </li>
                                        <li><a href="https://twitter.com/CarsonFarmer"><i class="fa fa-twitter"></i> twitter</a></li>
                                        <li><a href="https://github.com/cfarmer"><i class="fa fa-github"></i> github</a></li>
                                        <li><a href="http://about.me/carson.farmer"><i class="fa fa-user"></i> about.me</a></li>
                                        <li><a href="http://hunter-cuny.academia.edu/CarsonFarmer"><i class="fa fa-book"></i> academia.edu</a></li>
                                        <li><a href="http://www.linkedin.com/pub/carson-farmer/40/3bb/27/"><i class="fa fa-linkedin"></i> linkedin</a></li>
                                        <li><a href="https://plus.google.com/108062014159451325697/about/p/pub"><i class="fa fa-google-plus"></i> google+</a></li>
                                        <li><a href="http://cuny.is/cfarmer"><i class="fa fa-comment-o"></i> cuny.is</a></li>
                                        <li><a href="mailto:carson.farmer@gmail.com"><i class="fa fa-envelope"></i> email</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
        </header>
<section id="content" class="body">
  <article class="hentry shadow">
    <header>
      <h1 class="entry-title">
        <a href="http://www.carsonfarmer.com/2010/04/speeding-up-geoprocessing-in-qgis/" rel="bookmark"
           title="Permalink to Speeding up geoprocessing in QGIS">Speeding up geoprocessing in&nbsp;<span class="caps">QGIS</span></a></h1>
      <abbr class="published" title="2010-04-01T14:55:00">
          <i class="icon-calendar"></i>
          Thu 01 April 2010
      </abbr>
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="CarsonFarmer">Tweet</a>
<script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
<div class="g-plusone" data-size="medium"></div>
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">
 lang: en_US
</script>
<script type="IN/Share" data-counter="right"></script>    </header>

    <div class="entry-content">
      <p>Last night I had an uncontrollable urge to make geopoprocessing in <span class="caps">QGIS</span>
better, faster and more fun! I had come across a couple of posts
(<a href="http://lin-ear-th-inking.blogspot.com/search?q=cascaded">here</a>, <a href="http://blog.cleverelephant.ca/2009/01/must-faster-unions-in-postgis-14.html">here</a>) on the idea of a cascaded union operation, and
since it has recently been added to <a href="http://trac.osgeo.org/geos/"><span class="caps">GEOS</span></a> (which <span class="caps">QGIS</span> uses for its
geometry operations), I thought I&#8217;d give a much needed boost to the
fTools union tool and related functions.
</p>
<p>This required a bit of mucking about with <a href="http://doc.qgis.org/stable/classQgsGeometry.html">QgsGeometry</a>, but in the
end it really didn&#8217;t take too much hacking to get things working
properly. I was able to add a <code>combineCascaded(QList&lt;QgsGeometry*&gt;)</code>
function to the <code>QgsGeometry</code> class, as well as the required Python
bindings. Basically what this function does is union small subsets of
the input layer, then union groups of the resulting features, and so on
recursively until the final union of all features in the input list is
computed. There is a nice explanation of the algorithm straight from the
horses mouth <a href="http://lin-ear-th-inking.blogspot.com/search?q=cascaded">here</a>.</p>
<p>I haven&#8217;t yet committed these additions, as I&#8217;m not quite sure I like
how I&#8217;ve done things, but just to prove how much faster things can be,
here is a quick little demo that can be run from the built-in <span class="caps">QGIS</span>
Python&nbsp;console:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>
<span class="n">canvas</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">mapCanvas</span><span class="p">()</span>
<span class="n">layer</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c"># assumes target layer is fist in layer list</span>
<span class="n">provider</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span>
<span class="n">attrs</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">attributeIndexes</span><span class="p">()</span>
<span class="n">provider</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
<span class="n">geoms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">feat</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">()</span>
<span class="c"># get a list of all the feature geometries in the layer</span>
<span class="k">while</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">nextFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)):</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">QgsGeometry</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
    <span class="n">geoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
</pre></div>


<p>First, using the current method, which adds all the geometries together one by&nbsp;one:</p>
<div class="highlight"><pre><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">regular_geom</span> <span class="o">=</span> <span class="n">geom</span> <span class="c"># start with the last geometry in the layer</span>
<span class="k">for</span> <span class="n">geometry</span> <span class="ow">in</span> <span class="n">geoms</span><span class="p">:</span>
    <span class="n">regular_geom</span> <span class="o">=</span> <span class="n">QgsGeometry</span><span class="p">(</span><span class="n">regular_geom</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">geometry</span><span class="p">))</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span>
<span class="k">print</span> <span class="n">total</span>
</pre></div>


<p>Secondly, using cascaded union, which uses magic to combine geometries together
more efficiently. Also requires fewer lines of&nbsp;code!</p>
<div class="highlight"><pre><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">cascaded_geom</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">combineCascaded</span><span class="p">(</span><span class="n">geoms</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span>
<span class="k">print</span> <span class="n">total</span>
</pre></div>


<p>When I tested this last night on the <code>grassland.shp</code> layer from the
<a href="http://www.qgis.org/en/download/sample-data.html"><span class="caps">QGIS</span> sample dataset</a> the results were about <strong>86.89</strong> seconds for the
&#8216;old&#8217; method, and <strong>6.14</strong> seconds for the cascaded union method. That&#8217;s
a <strong>14.15</strong> times speedup on a relatively small layer (about 143
features of varying complexity)! I&#8217;ve tested the function on both
poylgons and lines so far, and it appears to work quite nicely.
Eventually I&#8217;ll add this to the official <span class="caps">QGIS</span> <span class="caps">API</span> so that others can
take advantage of the speedup. Additionally, the other fTools functions
which rely to some degree on unioning will also benefit from the extra
speed, which is always a good&nbsp;thing.</p>
    <p class="category">
        <i class="icon-certificate"></i>
        <a href="http://www.carsonfarmer.com/category/announcement.html">Announcement</a> 
    </p>
    <p class="tag">
        <i class="icon-tags"></i>
 <a href="http://www.carsonfarmer.com/tag/c.html">C++</a>
 <a href="http://www.carsonfarmer.com/tag/geoprocessing.html">geoprocessing</a>
 <a href="http://www.carsonfarmer.com/tag/python.html">Python</a>
 <a href="http://www.carsonfarmer.com/tag/qgis.html">QGIS</a>
 <a href="http://www.carsonfarmer.com/tag/free-open-source-software-foss.html">Free open-source software (FOSS)</a>
 <a href="http://www.carsonfarmer.com/tag/geographic-information-sciencesystems-gis.html">Geographic information science/systems (GIS)</a>
    </p>
    </div><!-- /.entry-content -->
      <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          var disqus_identifier = "2010/04/speeding-up-geoprocessing-in-qgis/";
          var disqus_url = "http://www.carsonfarmer.com/2010/04/speeding-up-geoprocessing-in-qgis/";
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://carsonfarmer.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </div>

  </article>
</section>
        <section id="extras" class="body shadow">
<div class="twitter">
    <h2><i class="icon-twitter"></i> twitter</h2>
    <a class="twitter-timeline" href="https://twitter.com/CarsonFarmer" 
        data-chrome="nofooter noheader noborders transparent" 
        data-widget-id="330339195518337025"
        height="300" lang="EN"
        data-related="CarsonFarmer">
        Tweets by @CarsonFarmer
    </a>
    <script>
        !function(d,s,id){
            var js,fjs=d.getElementsByTagName(s)[0], p=/^http:/.test(d.location)?'http':'https';
            if(!d.getElementById(id)){
                js=d.createElement(s);
                js.id=id;js.src=p+"://platform.twitter.com/widgets.js";
                fjs.parentNode.insertBefore(js,fjs);
            }
        }(document,"script","twitter-wjs");
    </script>
</div>
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body ">
            <address id="about" class="vcard body shadow">
                <ul id="links">
                    <li><a href="http://www.carsonfarmer.com/categories.html">Categories</a></li>
                    <li><a href="http://www.carsonfarmer.com/tags.html">Tags</a></li>
                </ul>
                Carson Farmer | Assistant Professor of GIScience | Department Geography</br>
                Hunter College, CUNY | 695 Park Avenue, New York, NY, 10065</br>
            </address><!-- /#about -->
            <p style="text-align: center; color: #fff;">This blog is proudly 
                powered by <a href="http://getpelican.com/">Pelican</a>, 
                which takes great advantage of 
                <a href="http://python.org">Python</a>.</br>
                Icons are courtesy of 
                <a href="http://fortawesome.github.io/Font-Awesome/">FontAwesome</a> 
                and the styling is mostly done via 
                <a href="http://getbootstrap.com/">Bootstrap</a>.</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41110370-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'carsonfarmer';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script src="http://www.carsonfarmer.com/theme/js/tools.js"></script>
</body>
</html>