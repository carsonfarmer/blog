<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
        <title>Speeding up geoprocessing in QGIS</title>
        <link rel="stylesheet" href="http://cfarmer.github.io/blog/theme/css/main.css">
                <link href="http://cfarmer.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Carson Farmer Atom Feed" />
                        <link href="http://cfarmer.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Carson Farmer RSS Feed" />
                        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script src="http://cfarmer.github.io/blog/static/libs/bootstrap/js/bootstrap.js"></script>
        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://cfarmer.github.io/blog/">Carson Farmer  <strong>www.carsonfarmer.com</strong></a></h1>
                <div class="navbar">
                    <div class="navbar-inner">
                        <ul class="nav">
                            <li><a id="home" href="http://cfarmer.github.io/blog/"><i class="icon-home"></i></a></li>
                                <li class="divider-vertical"></li>
                                                                                                                            <li><a href="http://cfarmer.github.io/blog/about/"><i class="icon-info-sign"></i> About</a></li>
                                                                                                                                <li><a href="http://cfarmer.github.io/blog/curriculum-vitae/"><i class="icon-rocket"></i> Curriculum Vitae</a></li>
                                                                                                                                <li class="dropdown">
                                        <a class="dropdown-toggle" data-toggle="dropdown" id="Work-drop" role="button" href="#">
                                        <i class="icon-globe"></i> Work<i class="icon-chevron-down"></i></a>
                                        <ul class="dropdown-menu" role="menu" id="Work-menu" aria-labelledby="Work-drop">
                                                                                            <li><a href="http://cfarmer.github.io/blog/research/"><i class="icon-bar-chart"></i> Reserach</a></li>
                                                                                            <li><a href="http://cfarmer.github.io/blog/spatial-software/"><i class="icon-code"></i> Software</a></li>
                                                                                    </ul>
                                    </li>
                                                                                                                                                                                <li class="dropdown pull-right">
                                    <a class="dropdown-toggle" data-toggle="dropdown" role="button" id="social-drop" href="#">
                                    <i class="icon-group"></i> Social<i class="icon-chevron-down"></i></a>
                                    <ul class="dropdown-menu" role="menu" id="social-menu" aria-labelledby="social-drop">
                                        <li>
                                          <a href="http://cfarmer.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">
                                          <i class="icon-rss"></i> atom feed</a>
                                        </li>
                                                                                <li>
                                          <a href="http://cfarmer.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">
                                          <i class="icon-rss"></i> rss feed</a>
                                        </li>
                                                                                                                            <li><a href="https://twitter.com/CarsonFarmer"><i class="icon-twitter"></i> twitter</a></li>
                                                                                    <li><a href="https://github.com/cfarmer"><i class="icon-github"></i> github</a></li>
                                                                                    <li><a href="http://about.me/carson.farmer"><i class="icon-user"></i> about.me</a></li>
                                                                                    <li><a href="http://hunter-cuny.academia.edu/CarsonFarmer"><i class="icon-book"></i> academia.edu</a></li>
                                                                                    <li><a href="http://www.linkedin.com/pub/carson-farmer/40/3bb/27/"><i class="icon-linkedin"></i> linkedin</a></li>
                                                                                    <li><a href="https://plus.google.com/108062014159451325697/about/p/pub"><i class="icon-google-plus"></i> google+</a></li>
                                                                                    <li><a href="mailto:carson.farmer@gmail.com"><i class="icon-envelope"></i> email</a></li>
                                                                            </ul>
                                </li>
                                                    </ul>
                    </div>
                </div>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article class="hentry shadow">
    <header>
      <h1 class="entry-title">
        <a href="http://cfarmer.github.io/blog/2010/04/speeding-up-geoprocessing-in-qgis/" rel="bookmark"
           title="Permalink to Speeding up geoprocessing in QGIS">Speeding up geoprocessing in&nbsp;<span class="caps">QGIS</span></a></h1>
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="CarsonFarmer">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
      <abbr class="published" title="2010-04-01T14:55:00">
          <i class="icon-calendar"></i>
          Thu 01 April 2010
      </abbr>
    </header>

    <div class="entry-content">
      <p>Last night I had an uncontrollable urge to make geopoprocessing in <span class="caps">QGIS</span>
better, faster and more fun! I had come across a couple of posts
(<a href="http://lin-ear-th-inking.blogspot.com/search?q=cascaded">here</a>, <a href="http://blog.cleverelephant.ca/2009/01/must-faster-unions-in-postgis-14.html">here</a>) on the idea of a cascaded union operation, and
since it has recently been added to <a href="http://trac.osgeo.org/geos/"><span class="caps">GEOS</span></a> (which <span class="caps">QGIS</span> uses for its
geometry operations), I thought I&#8217;d give a much needed boost to the
fTools union tool and related functions.
</p>
<p>This required a bit of mucking about with <a href="http://doc.qgis.org/stable/classQgsGeometry.html">QgsGeometry</a>, but in the
end it really didn&#8217;t take too much hacking to get things working
properly. I was able to add a <code>combineCascaded(QList&lt;QgsGeometry*&gt;)</code>
function to the <code>QgsGeometry</code> class, as well as the required Python
bindings. Basically what this function does is union small subsets of
the input layer, then union groups of the resulting features, and so on
recursively until the final union of all features in the input list is
computed. There is a nice explanation of the algorithm straight from the
horses mouth <a href="http://lin-ear-th-inking.blogspot.com/search?q=cascaded">here</a>.</p>
<p>I haven&#8217;t yet committed these additions, as I&#8217;m not quite sure I like
how I&#8217;ve done things, but just to prove how much faster things can be,
here is a quick little demo that can be run from the built-in <span class="caps">QGIS</span>
Python&nbsp;console:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>
<span class="n">canvas</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">mapCanvas</span><span class="p">()</span>
<span class="n">layer</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c"># assumes target layer is fist in layer list</span>
<span class="n">provider</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span>
<span class="n">attrs</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">attributeIndexes</span><span class="p">()</span>
<span class="n">provider</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
<span class="n">geoms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">feat</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">()</span>
<span class="c"># get a list of all the feature geometries in the layer</span>
<span class="k">while</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">nextFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)):</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">QgsGeometry</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
    <span class="n">geoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
</pre></div>


<p>First, using the current method, which adds all the geometries together one by&nbsp;one:</p>
<div class="highlight"><pre><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">regular_geom</span> <span class="o">=</span> <span class="n">geom</span> <span class="c"># start with the last geometry in the layer</span>
<span class="k">for</span> <span class="n">geometry</span> <span class="ow">in</span> <span class="n">geoms</span><span class="p">:</span>
    <span class="n">regular_geom</span> <span class="o">=</span> <span class="n">QgsGeometry</span><span class="p">(</span><span class="n">regular_geom</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">geometry</span><span class="p">))</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span>
<span class="k">print</span> <span class="n">total</span>
</pre></div>


<p>Secondly, using cascaded union, which uses magic to combine geometries together
more efficiently. Also requires fewer lines of&nbsp;code!</p>
<div class="highlight"><pre><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">cascaded_geom</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">combineCascaded</span><span class="p">(</span><span class="n">geoms</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span>
<span class="k">print</span> <span class="n">total</span>
</pre></div>


<p>When I tested this last night on the <code>grassland.shp</code> layer from the
<a href="http://www.qgis.org/en/download/sample-data.html"><span class="caps">QGIS</span> sample dataset</a> the results were about <strong>86.89</strong> seconds for the
&#8216;old&#8217; method, and <strong>6.14</strong> seconds for the cascaded union method. That&#8217;s
a <strong>14.15</strong> times speedup on a relatively small layer (about 143
features of varying complexity)! I&#8217;ve tested the function on both
poylgons and lines so far, and it appears to work quite nicely.
Eventually I&#8217;ll add this to the official <span class="caps">QGIS</span> <span class="caps">API</span> so that others can
take advantage of the speedup. Additionally, the other fTools functions
which rely to some degree on unioning will also benefit from the extra
speed, which is always a good&nbsp;thing.</p>
          <p class="category">
        <i class="icon-certificate"></i>
        <a href="http://cfarmer.github.io/blog/category/announcement.html">Announcement</a> 
            </p>
          <p class="tag">
        <i class="icon-tags"></i>
         <a href="http://cfarmer.github.io/blog/tag/c.html">C++</a>
         <a href="http://cfarmer.github.io/blog/tag/geoprocessing.html">geoprocessing</a>
         <a href="http://cfarmer.github.io/blog/tag/python.html">Python</a>
         <a href="http://cfarmer.github.io/blog/tag/qgis.html">QGIS</a>
         <a href="http://cfarmer.github.io/blog/tag/free-open-source-software-foss.html">Free open-source software (FOSS)</a>
         <a href="http://cfarmer.github.io/blog/tag/geographic-information-sciencesystems-gis.html">Geographic information science/systems (GIS)</a>
            </p>
    </div><!-- /.entry-content -->
          <div class="comments">
        <h2>Comments !</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          var disqus_identifier = "2010/04/speeding-up-geoprocessing-in-qgis/";
          var disqus_url = "http://cfarmer.github.io/blog/2010/04/speeding-up-geoprocessing-in-qgis/";
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://carsonfarmer.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </div>
    
  </article>
</section>
        <section id="extras" class="body shadow">
                    <div class="twitter">
        <h2><i class="icon-twitter"></i> twitter</h2>
        <a class="twitter-timeline" href="https://twitter.com/CarsonFarmer" 
            data-link-color="#2A75A9" 
            data-chrome="nofooter noheader noborders transparent" 
            data-widget-id="330339195518337025"
            height="300" lang="EN" 
            data-related="CarsonFarmer">
            Tweets by @CarsonFarmer
        </a>
        <script>
            !function(d,s,id){
                var js,fjs=d.getElementsByTagName(s)[0], p=/^http:/.test(d.location)?'http':'https';
                if(!d.getElementById(id)){
                    js=d.createElement(s);
                    js.id=id;js.src=p+"://platform.twitter.com/widgets.js";
                    fjs.parentNode.insertBefore(js,fjs);
                }
            }(document,"script","twitter-wjs");
        </script>

</div>
                
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body ">
                <address id="about" class="vcard body shadow">
                                                                            <ul id="links">
                                    <li><a href="http://www.geo.hunter.cuny.edu/cfarmer/">CUNY Faculty Page</a></li>
                                    <li><a href="http://www.carsilab.org/">CARSI Lab</a></li>
                                </ul>
                                            Carson Farmer| Assistant Professor of GIScience | Department Geography</br>
                Hunter College - CUNY | 695 Park Avenue, New York | New York, 10065</br>
                </address><!-- /#about -->
                <p style="text-align: center;">This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, 
                which takes great advantage of <a href="http://python.org">Python</a>.</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'carsonfarmer';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
    $(document).ready(function() {
    
        //Calculate the height of <header>
        //Use outerHeight() instead of height() if have padding
        var aboveHeight = $('.navbar').position().top;

    //when scroll
        $(window).scroll(function() {
            //if scrolled down more than the header’s height
                if ($(window).scrollTop() > aboveHeight){
                // if yes, add "fixed" class to the <nav>
                // add padding top to the #content 
                    // if (!$('nav').hasClass('fixed')) {
                    //     $('.home_link').show("slide", { direction: "right" }, 250)
                    // };
                    $('.navbar').addClass('fixed').css('top','0').next() //.addClass('navbar-fixed-top').next()//
                    $('#content').css('margin-top',aboveHeight+20+'px'); // value is same as the height of the nav
                } else {
                // when scroll up or less than aboveHeight,
                // remove the “fixed” class, and the padding-top
                    // if ($('nav').hasClass('fixed')) {
                    //     console.log('test')
                    //     $('.home_link').hide("slide", { direction: "right" }, 250)
                    // };
                    $('.navbar').removeClass('fixed').next()
                    $('#content').css('margin-top','0px');
                }
        });
    });
</script>
</body>
</html>